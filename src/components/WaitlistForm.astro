---
---

<div class="md:max-w-sm mx-auto">
	<form id="waitlist-form" class="flex flex-col gap-4 text-sm">
		<div class="flex flex-col gap-2">
			<label for="email" class="text-sm font-medium">
				Email 
			</label>
			<input
				type="email"
				id="email"
				name="email"
				required
				class="px-4 py-2 rounded-md border border-border bg-bg  text-(--sl-color-text) focus:outline-none focus:ring-2 focus:ring-(--sl-color-accent)"
				placeholder="you@example.com"
			/>
			<span class="text-red-500 text-sm hidden error-message" data-field="email"
			></span>
		</div>

		<div class="flex flex-col gap-2">
			<button
				type="submit"
				class="px-6 py-3 rounded-md bg-(--sl-color-accent) text-(--sl-color-black) font-medium hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
			>
				<span class="submit-text">Join the Waitlist</span>
				<span class="loading-text hidden">Submitting...</span>
			</button>
		</div>

		<div class="success-message hidden">
			<div
				class="p-4 rounded-md bg-green-500/10 border border-teal-500/50 text-teal-700 dark:text-teal-200"
			>
				<p class="font-medium">Thanks for joining the waitlist!</p>
				<p class="text-sm">
					Please check your email and click the verification link to confirm
					your registration.
				</p>
			</div>
		</div>

		<div class="general-error hidden">
			<div
				class="p-4 rounded-md bg-red-500/10 border-red-500/50 border text-red-700 dark:text-red-200"
			>
				<p class="text-sm error-text"></p>
			</div>
		</div>
	</form>
</div>

<script>
	const form = document.getElementById("waitlist-form") as HTMLFormElement;
	const submitButton = form?.querySelector(
		'button[type="submit"]',
	) as HTMLButtonElement;
	const submitText = submitButton?.querySelector(
		".submit-text",
	) as HTMLSpanElement;
	const loadingText = submitButton?.querySelector(
		".loading-text",
	) as HTMLSpanElement;
	const successMessage = form?.querySelector(
		".success-message",
	) as HTMLDivElement;
	const generalError = form?.querySelector(".general-error") as HTMLDivElement;
	const errorText = generalError?.querySelector(".error-text") as HTMLElement;

	form?.addEventListener("submit", async (e) => {
		e.preventDefault();

		// Clear previous errors
		document.querySelectorAll(".error-message").forEach((el) => {
			el.classList.add("hidden");
		});
		generalError?.classList.add("hidden");
		successMessage?.classList.add("hidden");

		// Get form data
		const formData = new FormData(form);
		const data = {
			email: formData.get("email")
		};

		// Set loading state
		submitButton.disabled = true;
		submitText.classList.add("hidden");
		loadingText.classList.remove("hidden");

		try {
			const response = await fetch("/api/signup-cloud", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify(data),
			});

			const result = await response.json();

			if (!response.ok) {
				// Handle validation errors
				if (result.errors && Array.isArray(result.errors)) {
					// Show field-specific errors
					result.errors.forEach((err: { field: string; message: string }) => {
						const errorElement = document.querySelector(
							`.error-message[data-field="${err.field}"]`,
						) as HTMLElement;
						if (errorElement) {
							errorElement.textContent = err.message;
							errorElement.classList.remove("hidden");
						}
					});
					// Don't throw, just show the field errors
					return;
				}
				// Show general error for non-validation errors
				throw new Error(result.error || "Failed to submit form");
			}

			// Show success message
			successMessage.classList.remove("hidden");
			form.reset();

			// Scroll to success message
			successMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
		} catch (error) {
			// Show general error message
			generalError.classList.remove("hidden");
			errorText.textContent =
				error instanceof Error ? error.message : "An error occurred";
		} finally {
			// Reset loading state
			submitButton.disabled = false;
			submitText.classList.remove("hidden");
			loadingText.classList.add("hidden");
		}
	});
</script>
